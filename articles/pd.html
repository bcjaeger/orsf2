<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Learn how to interpret ORSF models using partial dependence.
">
<title>PD and ICE curves with ORSF • aorsf</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="PD and ICE curves with ORSF">
<meta property="og:description" content="Learn how to interpret ORSF models using partial dependence.
">
<meta property="og:image" content="https://bcjaeger.github.io/aorsf/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">aorsf</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1.9002</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/aorsf.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/pd.html">PD and ICE curves with ORSF</a>
    <a class="dropdown-item" href="../articles/oobag.html">Out-of-bag predictions and evaluation</a>
    <a class="dropdown-item" href="../articles/fast.html">Tips to speed up computation</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/aorsf/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>PD and ICE curves with ORSF</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/aorsf/blob/HEAD/vignettes/pd.Rmd" class="external-link"><code>vignettes/pd.Rmd</code></a></small>
      <div class="d-none name"><code>pd.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="partial-dependence-pd">Partial dependence (PD)<a class="anchor" aria-label="anchor" href="#partial-dependence-pd"></a>
</h2>
<p>Partial dependence (PD) shows the expected prediction from a model as
a function of a single predictor or multiple predictors. The expectation
is marginalized over the values of all other predictors, giving
something like a multivariable adjusted estimate of the model’s
prediction.</p>
<p>Begin by fitting an ORSF ensemble. Set a prediction horizon of 5
years when we fit the ensemble so that any <code>aorsf</code> function
that we pass this ensemble to will assume we want to compute predictions
at 5 years.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/aorsf" class="external-link">aorsf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred_horizon</span> <span class="op">&lt;-</span> <span class="fl">365.25</span> <span class="op">*</span> <span class="fl">5</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">329730</span><span class="op">)</span></span>
<span></span>
<span><span class="va">index_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pbc_orsf</span><span class="op">)</span>, <span class="fl">150</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">pbc_orsf_train</span> <span class="op">&lt;-</span> <span class="va">pbc_orsf</span><span class="op">[</span><span class="va">index_train</span>, <span class="op">]</span></span>
<span><span class="va">pbc_orsf_test</span> <span class="op">&lt;-</span> <span class="va">pbc_orsf</span><span class="op">[</span><span class="op">-</span><span class="va">index_train</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf.html">orsf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pbc_orsf_train</span>, </span>
<span>            formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">id</span>,</span>
<span>            oobag_pred_horizon <span class="op">=</span> <span class="va">pred_horizon</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span></span>
<span><span class="co">#&gt; ---------- Oblique random survival forest</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      Linear combinations: Accelerated Cox regression</span></span>
<span><span class="co">#&gt;           N observations: 150</span></span>
<span><span class="co">#&gt;                 N events: 52</span></span>
<span><span class="co">#&gt;                  N trees: 500</span></span>
<span><span class="co">#&gt;       N predictors total: 17</span></span>
<span><span class="co">#&gt;    N predictors per node: 5</span></span>
<span><span class="co">#&gt;  Average leaves per tree: 10</span></span>
<span><span class="co">#&gt; Min observations in leaf: 5</span></span>
<span><span class="co">#&gt;       Min events in leaf: 1</span></span>
<span><span class="co">#&gt;           OOB stat value: 0.83</span></span>
<span><span class="co">#&gt;            OOB stat type: Harrell's C-statistic</span></span>
<span><span class="co">#&gt;      Variable importance: anova</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -----------------------------------------</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="three-ways-to-compute-pd">Three ways to compute PD<a class="anchor" aria-label="anchor" href="#three-ways-to-compute-pd"></a>
</h2>
<p>You can compute PD three ways with <code>aorsf</code>:</p>
<ul>
<li>
<p>using in-bag predictions for the training data</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">pd_inb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf_pd_oob.html">orsf_pd_inb</a></span><span class="op">(</span><span class="va">fit</span>, pred_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bili <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pd_inb</span></span>
<span><span class="co">#&gt;    pred_horizon bili     mean      lwr      medn      upr</span></span>
<span><span class="co">#&gt; 1:      1826.25    1 102.1908 10.53944  51.53224 387.8314</span></span>
<span><span class="co">#&gt; 2:      1826.25    2 118.4803 17.31700  65.55830 400.6156</span></span>
<span><span class="co">#&gt; 3:      1826.25    3 139.1412 27.34446  91.65943 408.3768</span></span>
<span><span class="co">#&gt; 4:      1826.25    4 164.1463 46.18300 121.88486 417.1405</span></span>
<span><span class="co">#&gt; 5:      1826.25    5 181.9151 63.41807 140.44002 418.7087</span></span></code></pre></div>
</li>
<li>
<p>using out-of-bag predictions for the training data</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">pd_oob</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf_pd_oob.html">orsf_pd_oob</a></span><span class="op">(</span><span class="va">fit</span>, pred_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bili <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pd_oob</span></span>
<span><span class="co">#&gt;    pred_horizon bili     mean       lwr     medn      upr</span></span>
<span><span class="co">#&gt; 1:      1826.25    1 37.76630  3.607834 20.75476 137.8659</span></span>
<span><span class="co">#&gt; 2:      1826.25    2 43.66964  6.664174 25.94357 143.4564</span></span>
<span><span class="co">#&gt; 3:      1826.25    3 51.14430 10.515231 33.65656 146.7145</span></span>
<span><span class="co">#&gt; 4:      1826.25    4 60.39396 16.973970 43.95543 148.7279</span></span>
<span><span class="co">#&gt; 5:      1826.25    5 66.85714 22.974170 53.15629 149.4068</span></span></code></pre></div>
</li>
<li>
<p>using predictions for a new set of data</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">pd_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf_pd_oob.html">orsf_pd_new</a></span><span class="op">(</span><span class="va">fit</span>, </span>
<span>                       new_data <span class="op">=</span> <span class="va">pbc_orsf_test</span>, </span>
<span>                       pred_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bili <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pd_test</span></span>
<span><span class="co">#&gt;    pred_horizon bili     mean      lwr     medn      upr</span></span>
<span><span class="co">#&gt; 1:      1826.25    1 121.9555 10.86471  88.9915 402.0936</span></span>
<span><span class="co">#&gt; 2:      1826.25    2 137.8438 19.81224 107.7018 411.1170</span></span>
<span><span class="co">#&gt; 3:      1826.25    3 159.1453 31.76190 134.2937 418.7824</span></span>
<span><span class="co">#&gt; 4:      1826.25    4 184.4208 52.09751 162.6736 427.0102</span></span>
<span><span class="co">#&gt; 5:      1826.25    5 202.1922 69.21315 179.9189 428.3857</span></span></code></pre></div>
</li>
<li><p>in-bag PD indicates relationships that the model has learned
during training. This is helpful if your goal is to interpret the
model.</p></li>
<li><p>out-of-bag PD indicates relationships that the model has learned
during training but using the out-of-bag data simulates application of
the model to new data. if you want to test your model’s reliability or
fairness in new data but you don’t have access to a large testing
set.</p></li>
<li><p>new data PD shows how the model predicts outcomes for
observations it has not seen. This is helpful if you want to test your
model’s reliability or fairness.</p></li>
</ul>
<p>Let’s re-fit our ORSF to all available data before proceeding to the
next sections.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">329730</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf.html">orsf</a></span><span class="op">(</span><span class="va">pbc_orsf</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span><span class="va">id</span>,</span>
<span>            oobag_pred_horizon <span class="op">=</span> <span class="va">pred_horizon</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="one-variable-one-horizon">One variable, one horizon<a class="anchor" aria-label="anchor" href="#one-variable-one-horizon"></a>
</h2>
<p>Computing PD for a single variable is straightforward:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">pd_sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf_pd_oob.html">orsf_pd_oob</a></span><span class="op">(</span><span class="va">fit</span>, pred_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"f"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pd_sex</span></span>
<span><span class="co">#&gt;    pred_horizon sex     mean      lwr     medn      upr</span></span>
<span><span class="co">#&gt; 1:      1826.25   m 63.55320 7.477198 42.75539 171.1608</span></span>
<span><span class="co">#&gt; 2:      1826.25   f 54.63958 2.484865 28.06003 173.0705</span></span></code></pre></div>
<p>The output shows that the expected predicted mortality risk for men
is substantially higher than women at 5 years after baseline.</p>
</div>
<div class="section level2">
<h2 id="one-variable-moving-horizon">One variable, moving horizon<a class="anchor" aria-label="anchor" href="#one-variable-moving-horizon"></a>
</h2>
<p>What if the effect of a predictor varies over time? PD can show
this.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">pd_sex_tv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf_pd_oob.html">orsf_pd_oob</a></span><span class="op">(</span><span class="va">fit</span>, pred_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"f"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         pred_horizon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">365</span>, <span class="fl">365</span><span class="op">*</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">pd_sex_tv</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">pred_horizon</span>, y <span class="op">=</span> <span class="va">mean</span>, color <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span> <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Time since baseline'</span>,</span>
<span>      y <span class="op">=</span> <span class="st">'Expected risk'</span><span class="op">)</span></span></code></pre></div>
<p><img src="pd_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>From inspection, we can see that males have higher risk than females
and the difference in that risk grows over time. This can also be seen
by viewing the ratio of expected risk over time:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ratio_tv</span> <span class="op">&lt;-</span> <span class="va">pd_sex_tv</span><span class="op">[</span></span>
<span> , <span class="fu">.</span><span class="op">(</span>ratio <span class="op">=</span> <span class="va">mean</span><span class="op">[</span><span class="va">sex</span> <span class="op">==</span> <span class="st">'m'</span><span class="op">]</span> <span class="op">/</span> <span class="va">mean</span><span class="op">[</span><span class="va">sex</span> <span class="op">==</span> <span class="st">'f'</span><span class="op">]</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">pred_horizon</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">ratio_tv</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">pred_horizon</span>, y <span class="op">=</span> <span class="va">ratio</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu">geom_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'grey'</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu">geom_smooth</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'black'</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">'time since baseline'</span>,</span>
<span>      y <span class="op">=</span> <span class="st">'ratio in expected risk for males versus females'</span><span class="op">)</span></span>
<span><span class="co">#&gt; `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</span></span></code></pre></div>
<p><img src="pd_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="multiple-variables-marginally">Multiple variables, marginally<a class="anchor" aria-label="anchor" href="#multiple-variables-marginally"></a>
</h2>
<p>If you want to compute PD marginally for multiple variables, just
list the variable values in <code>pred_spec</code> and specify
<code>expand_grid = FALSE</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">pd_two_vars</span> <span class="op">&lt;-</span>  </span>
<span> <span class="fu"><a href="../reference/orsf_pd_oob.html">orsf_pd_oob</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>             pred_spec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"f"</span><span class="op">)</span>, bili <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>             expand_grid <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pd_two_vars</span></span>
<span><span class="co">#&gt;    pred_horizon variable value level     mean       lwr     medn      upr</span></span>
<span><span class="co">#&gt; 1:      1826.25      sex    NA     m 63.55320  7.477198 42.75539 171.1608</span></span>
<span><span class="co">#&gt; 2:      1826.25      sex    NA     f 54.63958  2.484865 28.06003 173.0705</span></span>
<span><span class="co">#&gt; 3:      1826.25     bili     1  &lt;NA&gt; 43.75020  2.874963 23.84959 162.9211</span></span>
<span><span class="co">#&gt; 4:      1826.25     bili     2  &lt;NA&gt; 52.62373  7.354072 33.33673 166.1665</span></span>
<span><span class="co">#&gt; 5:      1826.25     bili     3  &lt;NA&gt; 61.84928 12.101608 44.86535 168.6863</span></span>
<span><span class="co">#&gt; 6:      1826.25     bili     4  &lt;NA&gt; 70.42316 15.812916 55.73172 170.9070</span></span>
<span><span class="co">#&gt; 7:      1826.25     bili     5  &lt;NA&gt; 76.65115 22.711616 64.05692 170.8388</span></span></code></pre></div>
<p>Now would it be tedious if you wanted to do this for all the
variables? You bet. That’s why we made a function for that. As a bonus,
the printed output is sorted from most to least important variables.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">pd_smry</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf_summarize_uni.html">orsf_summarize_uni</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pd_smry</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- bili (VI Rank: 1) ----------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median    25th %    75th %</span></span>
<span><span class="co">#&gt;             0.80 42.83597 23.25391  9.741911  65.93067</span></span>
<span><span class="co">#&gt;              1.4 46.46803 26.98826 11.838732  71.17473</span></span>
<span><span class="co">#&gt;              3.5 66.80175 51.27409 29.088045 100.58109</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- copper (VI Rank: 2) --------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median    25th %   75th %</span></span>
<span><span class="co">#&gt;               43 48.21215 25.62470  9.985469 80.81509</span></span>
<span><span class="co">#&gt;               74 51.73945 30.16273 11.583254 87.01429</span></span>
<span><span class="co">#&gt;              129 61.40508 40.92866 19.788045 98.90647</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- sex (VI Rank: 3) -----------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median   25th %    75th %</span></span>
<span><span class="co">#&gt;                m 63.55320 42.75539 20.19200 103.45252</span></span>
<span><span class="co">#&gt;                f 54.63958 28.06003 10.01858  97.26938</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- albumin (VI Rank: 4) -------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median    25th %    75th %</span></span>
<span><span class="co">#&gt;              3.3 58.55614 35.42032 12.302976 101.83702</span></span>
<span><span class="co">#&gt;              3.5 53.83906 29.43450 10.044261  95.62898</span></span>
<span><span class="co">#&gt;              3.8 50.70647 27.25834  9.374805  87.89383</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- stage (VI Rank: 5) ---------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median    25th %    75th %</span></span>
<span><span class="co">#&gt;                1 47.20443 24.36723  8.703312  80.08146</span></span>
<span><span class="co">#&gt;                2 49.29304 26.46830  9.004398  84.28718</span></span>
<span><span class="co">#&gt;                3 53.72875 29.10584  9.681819  93.04604</span></span>
<span><span class="co">#&gt;                4 61.85908 38.58617 14.873848 101.78250</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- protime (VI Rank: 6) -------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median   25th %    75th %</span></span>
<span><span class="co">#&gt;               10 51.55406 27.94644 10.05308  88.32145</span></span>
<span><span class="co">#&gt;               11 54.05145 30.98091 11.22662  97.16263</span></span>
<span><span class="co">#&gt;               11 58.09187 35.03346 13.42277 102.47232</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- age (VI Rank: 7) -----------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median    25th %   75th %</span></span>
<span><span class="co">#&gt;               42 49.88123 24.42597  9.393489 82.84776</span></span>
<span><span class="co">#&gt;               50 54.80366 32.10825 10.020049 93.78690</span></span>
<span><span class="co">#&gt;               57 60.67647 41.47291 13.845749 99.91527</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- ast (VI Rank: 8) -----------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median    25th %    75th %</span></span>
<span><span class="co">#&gt;               82 51.47090 27.12757  9.463567  89.29526</span></span>
<span><span class="co">#&gt;              117 54.63196 29.74198 10.320040  95.74545</span></span>
<span><span class="co">#&gt;              153 59.09659 32.91458 12.965747 103.62778</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- ascites (VI Rank: 9) -------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median   25th %    75th %</span></span>
<span><span class="co">#&gt;                0 54.63851 30.21167 10.18789  96.46022</span></span>
<span><span class="co">#&gt;                1 84.79354 71.87148 46.40669 119.16025</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- chol (VI Rank: 10) ---------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median    25th %   75th %</span></span>
<span><span class="co">#&gt;              250 52.55664 27.54958  8.790926 89.18335</span></span>
<span><span class="co">#&gt;              310 54.02951 29.06139  9.945881 95.23445</span></span>
<span><span class="co">#&gt;              401 57.93796 35.25995 13.815926 95.60699</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- hepato (VI Rank: 11) -------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median    25th %   75th %</span></span>
<span><span class="co">#&gt;                0 52.56707 28.06003  9.856122 92.20784</span></span>
<span><span class="co">#&gt;                1 58.54967 34.27944 12.509474 99.20459</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- edema (VI Rank: 12) --------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median   25th %    75th %</span></span>
<span><span class="co">#&gt;                0 53.82673 29.66470 10.07034  96.79712</span></span>
<span><span class="co">#&gt;              0.5 64.73309 42.35436 19.71526 108.19264</span></span>
<span><span class="co">#&gt;                1 83.58979 66.73237 47.14349 115.55102</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- spiders (VI Rank: 13) ------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median    25th %    75th %</span></span>
<span><span class="co">#&gt;                0 53.61324 28.19609  9.799982  93.01002</span></span>
<span><span class="co">#&gt;                1 61.01878 39.00764 16.009132 101.97723</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- trt (VI Rank: 14) ----------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median    25th %   75th %</span></span>
<span><span class="co">#&gt;  d_penicill_main 56.34027 31.91786 11.449614 96.46022</span></span>
<span><span class="co">#&gt;          placebo 55.53586 29.11532  9.938981 98.23438</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- trig (VI Rank: 15) ---------------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median    25th %   75th %</span></span>
<span><span class="co">#&gt;               85 53.71064 28.79787  9.734324 92.02106</span></span>
<span><span class="co">#&gt;              108 55.30092 30.36881 10.001856 94.88062</span></span>
<span><span class="co">#&gt;              151 58.00921 33.75819 11.839867 96.79045</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- alk.phos (VI Rank: 16) -----------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median   25th %    75th %</span></span>
<span><span class="co">#&gt;              922 55.74477 30.44920 10.45767  98.45809</span></span>
<span><span class="co">#&gt;             1278 55.91643 31.12989 10.30322  98.41736</span></span>
<span><span class="co">#&gt;             2068 56.64121 31.99537 10.97949 100.43647</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- platelet (VI Rank: 17) -----------------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  |--------------- Risk ---------------|</span></span>
<span><span class="co">#&gt;            Value     Mean   Median   25th %    75th %</span></span>
<span><span class="co">#&gt;              200 56.68413 31.14437 10.37195 101.89327</span></span>
<span><span class="co">#&gt;              257 55.62163 30.60753 10.26819  99.07328</span></span>
<span><span class="co">#&gt;              318 54.75102 28.93713 10.70150  98.50293</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Predicted risk at time t = 1826.25 for top 17 predictors</span></span></code></pre></div>
<p>It’s easy enough to turn this ‘summary’ object into a
<code>data.table</code> for downstream plotting and tables.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">pd_smry</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    variable importance Value     Mean   Median    25th %    75th % pred_horizon</span></span>
<span><span class="co">#&gt; 1:     bili 0.12486709  0.80 42.83597 23.25391  9.741911  65.93067      1826.25</span></span>
<span><span class="co">#&gt; 2:     bili 0.12486709   1.4 46.46803 26.98826 11.838732  71.17473      1826.25</span></span>
<span><span class="co">#&gt; 3:     bili 0.12486709   3.5 66.80175 51.27409 29.088045 100.58109      1826.25</span></span>
<span><span class="co">#&gt; 4:   copper 0.05296218    43 48.21215 25.62470  9.985469  80.81509      1826.25</span></span>
<span><span class="co">#&gt; 5:   copper 0.05296218    74 51.73945 30.16273 11.583254  87.01429      1826.25</span></span>
<span><span class="co">#&gt; 6:   copper 0.05296218   129 61.40508 40.92866 19.788045  98.90647      1826.25</span></span>
<span><span class="co">#&gt;    level</span></span>
<span><span class="co">#&gt; 1:  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2:  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3:  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4:  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5:  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6:  &lt;NA&gt;</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multiple-variables-jointly">Multiple variables, jointly<a class="anchor" aria-label="anchor" href="#multiple-variables-jointly"></a>
</h2>
<p>PD can show the expected value of a model’s predictions as a function
of a specific predictor, or as a function of multiple predictors. For
instance, we can estimate predicted risk as a joint function of
<code>bili</code>, <code>edema</code>, and <code>trt</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">pred_spec</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bili <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, length.out <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                 edema <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">pbc_orsf_train</span><span class="op">$</span><span class="va">edema</span><span class="op">)</span>,</span>
<span>                 trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">pbc_orsf</span><span class="op">$</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pd_bili_edema</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf_pd_oob.html">orsf_pd_oob</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">pred_spec</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pd_bili_edema</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bili</span>, y <span class="op">=</span> <span class="va">medn</span>, col <span class="op">=</span> <span class="va">trt</span>, linetype <span class="op">=</span> <span class="va">edema</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">'Expected predicted risk'</span><span class="op">)</span></span></code></pre></div>
<p><img src="pd_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
<p>From inspection,</p>
<ul>
<li><p>the model’s predictions indicate slightly lower risk for the
placebo group, and these do not seem to change much at different values
of <code>bili</code> or <code>edema</code>.</p></li>
<li><p>There is a clear increase in predicted risk with higher levels of
<code>edema</code> and with higher levels of <code>bili</code></p></li>
<li>
<p>the slope of predicted risk as a function of <code>bili</code>
appears highest among patients with <code>edema</code> of 0.5. Is the
effect of <code>bili</code> modified by <code>edema</code> being 0.5? A
quick sanity check with <code>coxph</code> suggests there is.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">pbc_orsf</span><span class="op">$</span><span class="va">edema_05</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">pbc_orsf</span><span class="op">$</span><span class="va">edema</span> <span class="op">==</span> <span class="st">'0.5'</span>, <span class="st">'yes'</span>, <span class="st">'no'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_cph</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>,<span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">edema_05</span> <span class="op">*</span> <span class="va">bili</span>, </span>
<span>                 data <span class="op">=</span> <span class="va">pbc_orsf</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova</a></span><span class="op">(</span><span class="va">fit_cph</span><span class="op">)</span></span>
<span><span class="co">#&gt; Analysis of Deviance Table</span></span>
<span><span class="co">#&gt;  Cox model: response is Surv(time, status)</span></span>
<span><span class="co">#&gt; Terms added sequentially (first to last)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                loglik   Chisq Df Pr(&gt;|Chi|)    </span></span>
<span><span class="co">#&gt; NULL          -550.19                          </span></span>
<span><span class="co">#&gt; edema_05      -546.83  6.7248  1   0.009508 ** </span></span>
<span><span class="co">#&gt; bili          -513.59 66.4689  1  3.555e-16 ***</span></span>
<span><span class="co">#&gt; edema_05:bili -510.54  6.1112  1   0.013433 *  </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="individual-conditional-expectations-ice">Individual conditional expectations (ICE)<a class="anchor" aria-label="anchor" href="#individual-conditional-expectations-ice"></a>
</h2>
<p>Unlike partial dependence, which shows the expected prediction as a
function of one or multiple predictors, individual conditional
expectations (ICE) show the prediction for an individual observation as
a function of a predictor.</p>
<p>Just like PD, we can compute ICE using in-bag, out-of-bag, or testing
data, and the same principles apply. We’ll use out-of-bag estimates
here.</p>
</div>
<div class="section level2">
<h2 id="visualizing-ice-curves">Visualizing ICE curves<a class="anchor" aria-label="anchor" href="#visualizing-ice-curves"></a>
</h2>
<p>Inspecting the ICE curves for each observation can help identify
whether there is heterogeneity in a model’s predictions. I.e., does the
effect of the variable follow the same pattern for all the data, or are
there groups where the variable impacts risk differently?</p>
<p>I am going to turn off boundary checking in <code>orsf_ice_oob</code>
by setting <code>boundary_checks = FALSE</code>, and this will allow me
to generate ICE curves that go beyond the 90th percentile of
<code>bili</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">pred_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bili <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span>, length.out <span class="op">=</span> <span class="fl">25</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ice_oob</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orsf_ice_oob.html">orsf_ice_oob</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">pred_spec</span>, boundary_checks <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ice_oob</span></span>
<span><span class="co">#&gt;       id_variable id_row pred_horizon bili      pred</span></span>
<span><span class="co">#&gt;    1:           1      1      1826.25    1 163.64623</span></span>
<span><span class="co">#&gt;    2:           1      2      1826.25    1  19.97562</span></span>
<span><span class="co">#&gt;    3:           1      3      1826.25    1 131.08783</span></span>
<span><span class="co">#&gt;    4:           1      4      1826.25    1  62.62504</span></span>
<span><span class="co">#&gt;    5:           1      5      1826.25    1  17.91457</span></span>
<span><span class="co">#&gt;   ---                                               </span></span>
<span><span class="co">#&gt; 6896:          25    272      1826.25   10  47.08761</span></span>
<span><span class="co">#&gt; 6897:          25    273      1826.25   10  81.39801</span></span>
<span><span class="co">#&gt; 6898:          25    274      1826.25   10  88.73318</span></span>
<span><span class="co">#&gt; 6899:          25    275      1826.25   10  52.07688</span></span>
<span><span class="co">#&gt; 6900:          25    276      1826.25   10  91.82502</span></span></code></pre></div>
<ul>
<li><p><code>id_variable</code> is an identifier for the current value
of the variable(s) that are in the data. It is redundant if you only
have one variable, but helpful if there are multiple variables.</p></li>
<li><p><code>id_row</code> is an identifier for the observation in the
original data. It is used to group an observation’s predictions together
in plots.</p></li>
</ul>
<p>For plots, it is helpful to scale the ICE data. I subtract the
initial value of predicted risk (i.e., when <code>bili = 1</code>) from
each observation’s conditional expectation values. So,</p>
<ul>
<li><p>Every curve start at 0</p></li>
<li>
<p>The plot shows <em>change</em> in predicted risk as a function of
<code>bili</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">ice_oob</span><span class="op">[</span>, <span class="va">pred_subtract</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">pred</span><span class="op">[</span><span class="va">id_variable</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span>, times<span class="op">=</span><span class="fl">25</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">ice_oob</span><span class="op">[</span>, <span class="va">pred</span> <span class="op">:=</span> <span class="va">pred</span> <span class="op">-</span> <span class="va">pred_subtract</span><span class="op">]</span></span></code></pre></div>
</li>
</ul>
<p>Now we can visualize the curves.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ice_oob</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bili</span>, </span>
<span>                    y <span class="op">=</span> <span class="va">pred</span>, </span>
<span>                    group <span class="op">=</span> <span class="va">id_row</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">'Change in predicted risk'</span><span class="op">)</span> <span class="op">+</span></span>
<span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</span></span></code></pre></div>
<p><img src="pd_files/figure-html/-orsf_ice-1.png" width="672"></p>
<p>From inspection of the figure,</p>
<ul>
<li><p>Most of the individual slopes cluster around the overall trend -
Good!</p></li>
<li><p>A small number of individual slopes appear to be flat. It may be
helpful to investigate this further.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="limitations-of-pd">Limitations of PD<a class="anchor" aria-label="anchor" href="#limitations-of-pd"></a>
</h2>
<p>Partial dependence has a number of <a href="https://christophm.github.io/interpretable-ml-book/pdp.html#disadvantages-5" class="external-link">known
limitations and assumptions</a> that users should be aware of (see
Hooker, 2021). In particular, partial dependence is less intuitive when
&gt;2 predictors are examined jointly, and it is assumed that the
feature(s) for which the partial dependence is computed are not
correlated with other features (this is likely not true in many cases).
Accumulated local effect plots can be used (see <a href="https://christophm.github.io/interpretable-ml-book/ale.html" class="external-link">here</a>)
in the case where feature independence is not a valid assumption.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ol style="list-style-type: decimal">
<li>Giles Hooker, Lucas Mentch, Siyu Zhou. Unrestricted Permutation
forces Extrapolation: Variable Importance Requires at least One More
Model, or There Is No Free Variable Importance. <em>arXiv e-prints</em>
2021 Oct; arXiv-1905. URL: <a href="https://doi.org/10.48550/arXiv.1905.03151" class="external-link uri">https://doi.org/10.48550/arXiv.1905.03151</a>
</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Byron Jaeger.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
